@page "/fornecedor/produtos/novo"

@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using RCL.Data.Model
@using RCL.Data.Interfaces
@using RCL.Data.Model.Enums;

@attribute [Authorize(Roles = "Fornecedor")]

@inject IProdutoService ProdutoService
@inject AuthenticationStateProvider AuthProvider
@inject NavigationManager Nav

<h3>Adicionar Novo Produto</h3>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger">@errorMessage</div>
}

<div class="card p-3">

    @* Nome *@
    <div class="mb-3">
        <label class="form-label">Nome</label>
        <input class="form-control" @bind="novoProduto.Nome" placeholder="Nome do produto" />
    </div>

    @* Descrição *@
    <div class="mb-3">
        <label class="form-label">Descrição</label>
        <textarea class="form-control" @bind="novoProduto.Descricao" rows="3"></textarea>
    </div>

    <div class="row">
        @* Preço *@
        <div class="col-md-6 mb-3">
            <label class="form-label">Preço Base (€)</label>
            <input type="number" class="form-control" @bind="novoProduto.Preco" step="0.01" />
        </div>

        @* Stock *@
        <div class="col-md-6 mb-3">
            <label class="form-label">Stock Inicial</label>
            <input type="number" class="form-control" @bind="novoProduto.Stock" />
        </div>
    </div>

    <div class="mb-3">
        <label class="form-label">Tipo</label>
        <select class="form-control" @bind="novoProduto.Tipo">
            <option value="@TipoProduto.Colecionavel">Colecionável</option>
            <option value="@TipoProduto.Complemento">Complemento</option>
        </select>
    </div>

    @* <div class="mb-3">
        <label class="form-label">Categoria (ID)</label>
        <input type="number" class="form-control" @bind="novoProduto.CategoriaId" />
    </div> *@

    <div class="mt-3">
        <button class="btn btn-primary" @onclick="SubmeterFormulario">Submeter</button>
        <button class="btn btn-secondary" @onclick="Cancelar">Cancelar</button>
    </div>

</div>

@code {
    private Produto novoProduto = new Produto
    {
        Nome = "",
        Descricao = "",
        Estado = EstadoProduto.PendenteAprovacao,
        Tipo = TipoProduto.Colecionavel
    };

    private string? errorMessage;

    private async Task SubmeterFormulario()
    {
        errorMessage = null;

        if (string.IsNullOrWhiteSpace(novoProduto.Nome))
        {
            errorMessage = "O nome é obrigatório.";
            return;
        }
        if (novoProduto.Preco <= 0)
        {
            errorMessage = "O preço tem de ser maior que zero.";
            return;
        }

        try
        {
            var authState = await AuthProvider.GetAuthenticationStateAsync();
            var userId = authState.User.FindFirst(c => c.Type == ClaimTypes.NameIdentifier)?.Value;

            if (string.IsNullOrEmpty(userId))
            {
                errorMessage = "Sessão inválida. Faça login novamente.";
                return;
            }

            novoProduto.FornecedorId = userId;
            novoProduto.Estado = EstadoProduto.PendenteAprovacao;

            await ProdutoService.InserirProdutoAsync(userId, novoProduto);

            Nav.NavigateTo("/fornecedor/home");
        }
        catch (Exception ex)
        {
            errorMessage = "Erro ao guardar: " + ex.Message;
        }
    }

    private void Cancelar()
    {
        Nav.NavigateTo("/fornecedor/home");
    }
}