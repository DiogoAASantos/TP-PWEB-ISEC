@page "/fornecedor/produtos/novo"

@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using RCL.Data.Model
@using RCL.Data.Interfaces
@using RCL.Data.Model.Enums;

@attribute [Authorize(Roles = "Fornecedor")]

@inject IProdutoService ProdutoService
@inject AuthenticationStateProvider AuthProvider
@inject ICategoriaService CategoriaService
@inject NavigationManager Nav

<h3>Adicionar Novo Produto</h3>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger">@errorMessage</div>
}

<div class="card p-3">
    <EditForm Model="novoProduto" OnValidSubmit="SubmeterFormulario">
        <DataAnnotationsValidator />
        <ValidationSummary />

        @* Nome *@
        <div class="mb-3">
            <label class="form-label">Nome</label>
            <InputText class="form-control" @bind-Value="novoProduto.Nome" placeholder="Nome do produto" />
            <ValidationMessage For="@(() => novoProduto.Nome)" />
        </div>

        @* Descrição *@
        <div class="mb-3">
            <label class="form-label">Descrição</label>
            <InputTextArea class="form-control" @bind-Value="novoProduto.Descricao" rows="3" />
            <ValidationMessage For="@(() => novoProduto.Descricao)" />
        </div>

        <div class="row">
            @* Preço *@
            <div class="col-md-6 mb-3">
                <label class="form-label">Preço Base (€)</label>
                <InputNumber class="form-control" @bind-Value="novoProduto.Preco" />
                <ValidationMessage For="@(() => novoProduto.Preco)" />
            </div>

            @* Stock *@
            <div class="col-md-6 mb-3">
                <label class="form-label">Stock Inicial</label>
                <InputNumber class="form-control" @bind-Value="novoProduto.Stock" />
                <ValidationMessage For="@(() => novoProduto.Stock)" />
            </div>
        </div>

        <div class="mb-3">
            <label class="form-label">Tipo</label>
            <InputSelect class="form-control" @bind-Value="novoProduto.Tipo">
                <option value="@TipoProduto.Colecionavel">Colecionável</option>
                <option value="@TipoProduto.Complemento">Complemento</option>
            </InputSelect>
        </div>

        <div class="mb-3">
            <label class="form-label">Categoria</label>
            <InputSelect class="form-control" @bind-Value="novoProduto.CategoriaId">
                <option value="0">-- Selecione uma Categoria --</option>

                @if (categorias == null)
                {
                    <option disabled>A carregar categorias...</option>
                }
                else
                {
                    @foreach (var cat in categorias)
                    {
                        <option value="@cat.Id">@cat.Nome</option>
                    }
                }
            </InputSelect>
            <ValidationMessage For="@(() => novoProduto.CategoriaId)" />
        </div>

        <div class="mt-3">
            <button type="submit" class="btn btn-primary">Submeter</button>

            <button type="button" class="btn btn-secondary" @onclick="Cancelar">Cancelar</button>
        </div>
    </EditForm>
</div>

@code {
    private List<CategoriaDTO> categorias = new();

    protected override async Task OnInitializedAsync()
    {
        categorias = await CategoriaService.ObterCategoriasAsync();
    }

    private Produto novoProduto = new Produto
    {
        Nome = "",
        Descricao = "",
        Estado = EstadoProduto.PendenteAprovacao,
        Tipo = TipoProduto.Colecionavel
    };

    private string? errorMessage;

    private async Task SubmeterFormulario()
    {
        errorMessage = null;

        if (string.IsNullOrWhiteSpace(novoProduto.Nome))
        {
            errorMessage = "O nome é obrigatório.";
            return;
        }
        if (novoProduto.Preco <= 0)
        {
            errorMessage = "O preço tem de ser maior que zero.";
            return;
        }

        try
        {
            var authState = await AuthProvider.GetAuthenticationStateAsync();
            var userId = authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;

            if (string.IsNullOrEmpty(userId))
            {
                errorMessage = "Sessão inválida. Faça login novamente.";
                return;
            }

            novoProduto.FornecedorId = userId;
            novoProduto.Estado = EstadoProduto.AVenda;

            await ProdutoService.InserirProdutoAsync(userId, novoProduto);

            Nav.NavigateTo("/fornecedor/home");
        }
        catch (Exception ex)
        {
            errorMessage = "Erro ao guardar: " + ex.Message;
        }
    }

    private void Cancelar()
    {
        Nav.NavigateTo("/fornecedor/home");
    }
}