@page "/fornecedor/produtos/editar/{ProdutoId:int}"

@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using RCL.Data.Model
@using RCL.Data.Interfaces
@using RCL.Data.Model.Enums

@attribute [Authorize(Roles = "Fornecedor")]

@inject IProdutoService ProdutoService
@inject AuthenticationStateProvider AuthProvider
@inject NavigationManager Nav

<h3>Gerir Produto</h3>

@if (isLoading)
{
    <p>A carregar...</p>
}
else if (produto == null)
{
    <div class="alert alert-danger">Produto não encontrado ou acesso não autorizado.</div>
    <button class="btn btn-secondary" @onclick="Voltar">Voltar</button>
}
else
{
    <div class="card p-3">

        <div class="mb-3">
            <label class="form-label">Nome</label>
            <input class="form-control" @bind="produto.Nome" />
        </div>

        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">Preço (€)</label>
                <input type="number" class="form-control" @bind="produto.Preco" step="0.01" />
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">Stock</label>
                <input type="number" class="form-control" @bind="produto.Stock" />
            </div>
        </div>

        <div class="alert alert-warning">
            <strong>Nota:</strong> Ao guardar alterações, o produto voltará ao estado <strong>Pendente</strong> para nova aprovação.
        </div>

        <div class="d-flex gap-2">
            <button class="btn btn-success" @onclick="GuardarAlteracoes">Guardar Alterações</button>

            <button class="btn btn-warning" @onclick="SuspenderProduto">
                Suspender Venda (Remover da Loja)
            </button>

            <button class="btn btn-secondary" @onclick="Voltar">Cancelar</button>
        </div>

    </div>
}

@code {
    [Parameter] public string ProdutoId { get; set; }

    private Produto? produto;
    private bool isLoading = true;
    private string currentUserId = "";

    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var authState = await AuthProvider.GetAuthenticationStateAsync();
            currentUserId = authState.User.FindFirst(c => c.Type == ClaimTypes.NameIdentifier)?.Value ?? "";

            var p = await ProdutoService.ObterProdutoPorIdAsync(ProdutoId);

            if (p != null && p.FornecedorId == currentUserId)
            {
                produto = p;
            }
            else
            {
                produto = null;
            }
        }
        catch (Exception)
        {
            produto = null;
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task GuardarAlteracoes()
    {
        errorMessage = null;

        if (produto == null) return;

        try
        {
            produto.Estado = EstadoProduto.PendenteAprovacao;

            var produtoAtualizado = await ProdutoService.EditarProdutoAsync(currentUserId, produto);

            if (produtoAtualizado != null)
            {
                Nav.NavigateTo("/fornecedor/home");
            }
            else
            {
                errorMessage = "Erro ao guardar alterações. Tente novamente.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = "Ocorreu um erro: " + ex.Message;
        }
    }

    private async Task SuspenderProduto()
    {
        errorMessage = null;

        if (produto == null) return;

        try
        {
            var sucesso = await ProdutoService.AlterarEstadoProdutoAsync(currentUserId, produto.Id, EstadoProduto.PendenteAprovacao);

            if (sucesso)
            {
                Nav.NavigateTo("/fornecedor/home");
            }
            else
            {
                errorMessage = "Não foi possível suspender o produto. Verifique se existem encomendas ativas.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = "Erro de comunicação: " + ex.Message;
        }
    }

    private void Voltar()
    {
        Nav.NavigateTo("/fornecedor/home");
    }
}