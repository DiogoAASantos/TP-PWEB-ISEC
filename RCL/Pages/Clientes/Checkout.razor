@page "/checkout"

@using RCL.Data.Model
@using RCL.Data.Interfaces
@using Microsoft.JSInterop  
@inject ICarrinhoService CarrinhoService
@inject IEncomendaService EncomendaService
@inject NavigationManager Nav
@inject IJSRuntime JS 

<h2>Finalizar Compra</h2>

@if (itensCarrinho == null || !itensCarrinho.Any())
{
    <p>O seu carrinho está vazio.</p>
}
else
{
    <table class="table">
        <thead>
            <tr>
                <th>Produto</th>
                <th>Preço Unitário</th>
                <th>Quantidade</th>
                <th>Subtotal</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in itensCarrinho)
            {
                <tr>
                    <td>@item.Produto.Nome</td>
                    <td>@item.Produto.Preco €</td>
                    <td>@item.Quantidade</td>
                    <td>@(item.Produto.Preco* item.Quantidade) €</td>
                </tr>
            }
        </tbody>
    </table>

    <p><strong>Total:</strong> @totalCarrinho €</p>

    <button class="btn btn-success" @onclick="FinalizarCompra">Finalizar Compra</button>
}

@code {
    private List<CarrinhoItem> itensCarrinho = new();
    private decimal totalCarrinho;

    protected override async Task OnInitializedAsync()
    {
        itensCarrinho = await CarrinhoService.ObterItensAsync();
        totalCarrinho = await CarrinhoService.TotalAsync();
    }

    private async Task FinalizarCompra()
    {
        // Efetivar encomenda via serviço
        var encomenda = await EncomendaService.EfetivarCompraAsync();

        if (encomenda != null)
        {
            // Limpar carrinho local
            CarrinhoService.LimparCarrinhoLocal();

            // Redirecionar para página de histórico de compras
            Nav.NavigateTo("/historico");
        }
        else
        {
            await JS.InvokeVoidAsync("alert", "Erro ao finalizar compra. Tente novamente.");
        }
    }
}
